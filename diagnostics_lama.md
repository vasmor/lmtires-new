# План диагностики и оценки качества обученности модели LaMa

## 1. Проверка логов обучения и анализ лоссов
- Перейти в директорию `lama-local/bin`:
  ```sh
  cd lama-local/bin
  ```
- Запустить анализатор лоссов с указанием пути к csv-файлу (пример для Windows/venv39):
  ```sh
  ..\..\venv39\Scripts\python.exe ..\analyze_losses_summary.py ..\outputs\2025-06-27\13-18-51\tb_logs\13-18-51\version_0\losses_metrics.csv
  ```
  Если вывод не появляется — сохранить результат в файл:
  ```sh
  ..\..\venv39\Scripts\python.exe ..\analyze_losses_summary.py ..\outputs\2025-06-27\13-18-51\tb_logs\13-18-51\version_0\losses_metrics.csv > losses_summary.txt
  ```
- Найти файл `losses_metrics.csv` в папке:
  ```
  lama-local/outputs/<дата>/<время>/tb_logs/<время>/version_0/
  ```
- Провести анализ по каждому лоссу/метрике: выписать min, max, mean, last, сделать краткий вывод по динамике и значению каждого лосса.
  - Пример формата для отчёта:
    ```
    train_gen_l1: min=0.00104, max=0.00580, mean=0.00312, last=0.00243 — лосс стабильно снижается, модель хорошо аппроксимирует таргет.
    train_gen_pl: min=0.04257, max=0.15548, mean=0.07324, last=0.05516 — perceptual loss снижается, качество генерации хорошее.
    train_gen_adv: всегда 0 — не обучался (отключён).
    hp_metric: всегда -1 — не рассчитывается.
    ```

## 2. Визуализация результатов на валидации

- Перейти в директорию с визуализациями результатов по эпохам:
  ```
  lama-local/outputs/<дата>/<время>/outputs/visualization/
  ```
  Например:
  ```
  lama-local/outputs/2025-06-27/13-18-51/outputs/visualization/
  ```

- В каждой подпапке `epochXXXX_train/` содержатся изображения (например, `batch0000000.jpg`), которые показывают результаты inpainting на валидационном датасете для соответствующей эпохи.

- Для анализа:
  - Открыть изображения из разных эпох (например, `epoch0020_train/`, `epoch0025_train/`, ..., `epoch0039_train/`).
  - Сравнить визуально качество восстановления: насколько хорошо замаскированные области восстанавливаются, есть ли артефакты, улучшается ли результат с ростом номера эпохи.
  - Обратить внимание на типичные ошибки: размытость, артефакты, неестественные границы, повторяющиеся паттерны и т.д.

- Рекомендации:
  - Для быстрой навигации можно использовать просмотрщик изображений с поддержкой перехода по папкам (например, XnView, IrfanView, стандартный просмотрщик Windows).
  - Для отчёта сохранить 2–3 характерных примера (до/после) из разных эпох и кратко описать динамику качества.

- Пример формата для отчёта:
  ```
  epoch0020_train: заметны артефакты на границах маски, восстановление неестественное.
  epoch0029_train: качество заметно улучшилось, артефактов меньше, но есть небольшая размытость.
  epoch0039_train: восстановление близко к оригиналу, артефакты минимальны.
  ```

**Общий вывод по визуализации:**
Восстановление структуры рисунка протектора реализовано плохо:
- Детали не восстанавливаются, структура рисунка практически отсутствует.
- Изображения сильно замылены, видны только основные точки структуры, но не их форма.
- Качество не улучшается существенно с ростом эпохи — артефакты и размытость сохраняются.

## 3. Инференс на валидационном датасете

- Перейти в директорию `lama-local/bin`:
  ```sh
  cd lama-local/bin
  ```

- Использовать конфиг для инференса:
  ```
  lama-local\configs\prediction\default_eval_valset.yaml
  ```

- Запустить инференс на валидационном датасете командой (пример для Windows/venv39):
  ```sh
  $env:PYTHONPATH=".."; ..\..\venv39\Scripts\python.exe predict.py --config-name=default_eval_valset.yaml --config-path=../configs/prediction
  ```
  - Если используете PowerShell, переменная окружения задаётся как показано выше.
  - Если используете cmd:
    ```sh
    set PYTHONPATH=..
    ..\..\venv39\Scripts\python.exe predict.py --config-name=default_eval_valset.yaml --config-path=../configs/prediction
    ```

- Результаты инференса будут сохранены в папке, указанной в параметре `outdir` конфига (например, `val_inpainted`).

- После завершения инференса:
  - Убедиться, что в папке результатов появились inpainted-изображения.
  - Проверить, что количество файлов совпадает с количеством масок/оригиналов в валидационном датасете.
  - Если возникли ошибки — зафиксировать корректную команду и комментарий в чек-листе.

- Пример формата для отчёта:
  ```
  Инференс завершён успешно, результаты в папке val_inpainted, количество файлов совпадает с валидным датасетом.
  ```

## 4. Оценка метрик (PSNR, SSIM, LPIPS, FID)
- Использовать скрипт `eval_inpaint_metrics.py` или аналогичный.
- Пример команды:
  ```sh
  ..\..\venv39\Scripts\python.exe eval_inpaint_metrics.py --pred_dir val_inpainted --gt_dir valid-dataset/val_images --mask_dir valid-dataset/val_masks
  ```
- Проверить, что метрики считаются корректно, нет ошибок по путям и формату файлов.

## 5. Sanity check на обучающих примерах
- Прогнать 1-2 изображения из train-датасета через инференс (конфиг `sanity_check.yaml`).
- Пример команды:
  ```sh
  $env:PYTHONPATH=".."; ..\..\venv39\Scripts\python.exe predict.py --config-name=sanity_check.yaml --config-path=../configs/prediction
  ```
- Проверить, что результат близок к оригиналу.

## 6. Проверка структуры и содержимого масок
- Проанализировать, как выглядят маски в train/val-датасете (размер, заполненность, не пустые ли).
- Визуализировать несколько случайных пар (оригинал, маска, masked_img).

## 7. Проверка структуры checkpoint
- Убедиться, что checkpoint содержит обученные веса, а не случайную инициализацию.
- При необходимости сравнить state_dict между этапами (скрипт сравнения параметров).

## 8. Проверка на эталонных данных
- Прогнать инференс на публичных примерах из LaMa paper.
- Сравнить результат с опубликованными эталонами.

---

**В этот файл по ходу работы вносятся исправления и примеры успешных команд для твоего окружения. Если возникает ошибка — фиксируй здесь корректную команду и комментарий!** 